<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DuckDB API Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="bg-gray-100 p-8">
  <div x-data="apiDemo()" class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">DuckDB API Demo</h1>

    <div class="mb-6">
      <label for="tableSelect" class="block mb-2">Select Table:</label>
      <select id="tableSelect" x-model="selectedTable" @change="changeTable" class="border p-2 w-full max-w-xs">
        <option value="">Select a table</option>
        <template x-for="table in tables" :key="table.schema + '.' + table.name">
          <option :value="table.schema + '.' + table.name" x-text="table.schema + '.' + table.name"></option>
        </template>
      </select>
    </div>

    <template x-if="selectedTable">
      <div>
        <div class="mb-6">
          <h2 class="text-xl font-semibold mb-2">Add Record</h2>
          <form @submit.prevent="addRecord">
            <template x-for="column in selectedTableInfo.column_names" :key="column">
              <div class="mb-2">
                <label :for="column" x-text="column" class="block"></label>
                <input :id="column" :name="column" :type="getInputType(column)" class="border p-2 w-full max-w-md">
              </div>
            </template>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Add Record</button>
          </form>
        </div>

        <div class="mb-6">
          <h2 class="text-xl font-semibold mb-2" x-text="`${selectedTable} Records`"></h2>
          <button @click="getRecords" class="bg-green-500 text-white px-4 py-2 rounded mb-4">Refresh Records</button>
          <div class="overflow-x-auto">
            <table class="w-full bg-white shadow-md rounded">
              <thead>
                <tr>
                  <template x-for="column in selectedTableInfo.column_names" :key="column">
                    <th class="border p-2" x-text="column"></th>
                  </template>
                  <th class="border p-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="record in records" :key="record.id">
                  <tr>
                    <template x-for="column in selectedTableInfo.column_names" :key="column">
                      <td class="border p-2" x-text="record[column]"></td>
                    </template>
                    <td class="border p-2">
                      <button @click="deleteRecord(record.id)"
                        class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>
  </div>

  <script>
    function apiDemo() {
      return {
        tables: [],
        selectedTable: '',
        selectedTableInfo: null,
        records: [],
        async getTables() {
          const response = await fetch('/api/tables');
          this.tables = await response.json();
        },
        async getRecords() {
          const response = await fetch(`/api/${this.selectedTable}`);
          this.records = await response.json();
        },
        async addRecord(event) {
          const formData = new FormData(event.target);
          const data = Object.fromEntries(formData.entries());
          const response = await fetch(`/api/${this.selectedTable}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (response.ok) {
            event.target.reset();
            await this.getRecords();
          }
        },
        async deleteRecord(id) {
          const response = await fetch(`/api/${this.selectedTable}/${id}`, { method: 'DELETE' });
          if (response.ok) {
            await this.getRecords();
          }
        },
        changeTable() {
          if (this.selectedTable) {
            const [schema, name] = this.selectedTable.split('.');
            this.selectedTableInfo = this.tables.find(t => t.schema === schema && t.name === name);
            this.getRecords();
          } else {
            this.selectedTableInfo = null;
            this.records = [];
          }
        },
        getInputType(columnName) {
          const columnIndex = this.selectedTableInfo.column_names.indexOf(columnName);
          const columnType = this.selectedTableInfo.column_types[columnIndex];
          switch (columnType.toLowerCase()) {
            case 'integer':
              return 'number';
            case 'decimal(10,2)':
              return 'number';
            case 'timestamp':
              return 'datetime-local';
            default:
              return 'text';
          }
        },
        init() {
          this.getTables();
        }
      }
    }
  </script>
</body>

</html>